<!DOCTYPE html>
<html>
<head>
    <title>Research Paper Assistant</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            EmailAuthProvider, 
            reauthenticateWithCredential,
            updatePassword 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzdNhDTwzERyGp6xLCNxq5GM8iIOk8HoU",
            authDomain: "hkare-21691.firebaseapp.com",
            projectId: "hkare-21691",
            storageBucket: "hkare-21691.firebasestorage.app",
            messagingSenderId: "713242747070",
            appId: "1:713242747070:web:ff3e3a1e45f38518f43eef",
            measurementId: "G-JT7E86BZ3Q",
            databaseURL: "https://hkare-21691-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase objects globally accessible
        window.auth = auth;
        window.database = database;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbSet = set;
        window.dbChild = child;
        window.EmailAuthProvider = EmailAuthProvider;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.updatePassword = updatePassword;

        // Initialize profile when auth state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Auth state changed - user logged in:', user.email);
                loadUserProfile().catch(error => {
                    console.error('Failed to load profile on auth state change:', error);
                });
            }
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            position: relative;
            width: 100%;
            min-height: 100vh;
        }
        .search-box, .prompt-area {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .prompt-area {
            height: 200px;
            font-family: monospace;
        }
        .config-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .submit-btn, .save-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .results {
            margin-top: 20px;
        }
        .sources {
            margin-top: 20px;
            font-size: 14px;
        }
        .config-item {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 200px;
        }
        
        /* Tab Styles */
        .tab {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: #f1f1f1;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab button {
            padding: 12px 16px;
            border: none;
            background: inherit;
            cursor: pointer;
            transition: 0.3s;
            font-size: 16px;
            white-space: nowrap;
            border-radius: 4px;
        }

        .tab .nav-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tab .action-buttons {
            display: flex;
            gap: 5px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .generate-btn {
            padding: 12px 16px;
            white-space: nowrap;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            .tab {
                position: fixed;
                width: 100%;
            }

            .tabcontent {
                margin-top: 200px; /* Increased for mobile to account for stacked tab buttons */
                padding: 10px;
            }

            .section-selector {
                position: relative;
                top: 0;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .paper-layout {
                margin-left: 0;
                width: 100%;
            }

            /* Adjust other mobile styles as needed */
            .tab .nav-buttons,
            .tab .action-buttons {
                width: 100%;
            }

            .tab button {
                width: 100%;
            }
        }

        /* Active tab styling */
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }

        /* Hover effects */
        .tab button:hover:not(.active) {
            background-color: #e8f5e9;
            color: #4CAF50;
        }
        
        /* Show the default tab */
        #Search {
            display: block;
        }
        
        .api-key-input {
            width: 300px;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .api-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .error-message {
            color: red;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .success-message {
            color: green;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .research-summary h2 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .research-summary {
            line-height: 1.6;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .research-summary br {
            display: block;
            margin: 5px 0;
        }

        /* Research Assistant Styles */
        .chat-container {
            height: 600px;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-header {
            padding: 20px;
            background: #4CAF50;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
        }

        .user-message {
            margin-left: auto;
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 15px 15px 0 15px;
        }

        .assistant-message {
            margin-right: auto;
            background: white;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 15px 15px 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-input {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 10px 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 12px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }

        .chat-input button:hover {
            background: #45a049;
        }

        .loading {
            display: inline-block;
            margin-left: 10px;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80% { content: '....'; }
            100% { content: '.....'; }
        }

        /* Research Sections Styles */
        .research-sections {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 20px;
        }

        .paper-section {
            display: block;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            background: #4CAF50;
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .section-content {
            padding: 15px 0;
        }

        .section-nav {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .section-nav a {
            display: block;
            padding: 5px 10px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }

        .section-nav a:hover {
            background: #f0f0f0;
            border-radius: 3px;
        }

        /* Quick navigation menu */
        .quick-nav {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .quick-nav a {
            display: block;
            padding: 5px 10px;
            color: #333;
            text-decoration: none;
            font-size: 0.9em;
        }

        .quick-nav a:hover {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .section-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 100px;
            font-family: Arial, sans-serif;
        }

        .section-output {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }

        .section-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .generate-btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .generate-btn:hover {
            background: #45a049;
        }

        /* Configuration section styles */
        .prompt-sections {
            display: flex;
            gap: 20px;
        }

        .section-nav {
            width: 200px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .section-nav button {
            width: 100%;
            text-align: left;
            padding: 10px;
            margin: 5px 0;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
        }

        .section-nav button.active {
            background: #4CAF50;
            color: white;
        }

        .prompt-config {
            display: none;
            flex-grow: 1;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .prompt-config.active {
            display: block;
        }

        .prompt-area {
            width: 100%;
            min-height: 300px;
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .save-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .save-btn:hover {
            background: #45a049;
        }

        .section-link {
            color: #4CAF50;
            text-decoration: none;
            margin-left: 10px;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        .research-summary h2 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .research-summary {
            line-height: 1.6;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .research-summary br {
            display: block;
            margin: 5px 0;
        }

        .generated-content h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .generated-content h2 {
            font-size: 20px;
            color: #34495e;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        
        .generated-content h3 {
            font-size: 18px;
            color: #445566;
            margin-top: 12px;
            margin-bottom: 6px;
        }
        
        .generated-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .generated-content li {
            margin: 5px 0;
        }
        
        .generated-content p {
            margin: 10px 0;
        }
        
        .generated-content strong {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .generated-content em {
            font-style: italic;
            color: #34495e;
        }

        .section-selector {
            position: fixed;
            left: 0;
            top: 140px; /* Match the tabcontent margin-top */
            width: 280px;
            height: calc(100vh - 140px);
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow-y: auto;
        }

        .section-selector-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .input-mode-selector {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .combined-input {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .section-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: white;
        }

        .section-checkboxes {
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            padding-right: 5px;
        }

        .section-item {
            margin-bottom: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .section-label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
        }

        .section-label:hover {
            background: #f8f9fa;
        }

        .section-label input[type="checkbox"] {
            margin-right: 8px;
        }

        .individual-input {
            padding: 8px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .individual-input textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.9em;
        }

        #collectiveInput {
            width: 100%;
            height: 100px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.9em;
        }

        .generate-button-container {
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        /* Scrollbar styling */
        .section-checkboxes::-webkit-scrollbar {
            width: 6px;
        }

        .section-checkboxes::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .section-checkboxes::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .section-checkboxes::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .model-select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            background-color: white;
            color: #333;
            font-size: 14px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .model-select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.2);
        }

        .model-select option {
            padding: 10px;
            background-color: white;
            color: #333;
        }

        /* Add group styling */
        .model-select optgroup {
            font-weight: bold;
            color: #4CAF50;
            background-color: #f5f5f5;
        }
        
        #chatgptSettings, #geminiSettings {
            display: none;
        }

        .api-settings-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .api-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .api-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }

        .api-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .test-btn {
            background-color: #28a745;
            color: white;
        }

        .save-btn {
            background-color: #007bff;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .api-status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }

        #chatgptSettings,
        #geminiSettings {
            display: none;
        }

        .web-scraping-control {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .web-scraping-control label {
            margin-left: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .web-scraping-control input[type="checkbox"] {
            cursor: pointer;
            margin-right: 8px;
        }

        .loading {
            margin-top: 8px;
            color: #666;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80% { content: '....'; }
            100% { content: '.....'; }
        }

        .user-info {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 15px;
        }

        #userEmail {
            color: #333;
            font-size: 14px;
        }

        .logout-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 14px 16px;
            cursor: pointer;
            transition: 0.3s;
        }

        .logout-button:hover {
            background-color: #d32f2f;
        }

        /* Style for logout tab specifically */
        .tab button[onclick="logout()"]:hover {
            background-color: #d32f2f !important;
        }

        /* Tab content positioning */
        .tabcontent {
            position: relative;
            margin-top: 140px; /* Increased to account for tab height */
            z-index: 1;
            width: 100%;
        }

        .paper-layout {
            margin-left: 280px; /* Match the section-selector width */
            width: calc(100% - 280px); /* Subtract the section-selector width */
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* Loading spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: #333;
            font-size: 18px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .history-filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .history-entry {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: opacity 0.3s ease;
        }
        
        .history-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }
        
        .header-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .header-actions .download-btn {
            background-color: #2196F3;
        }
        
        .header-actions .copy-btn {
            background-color: #4CAF50;
        }
        
        .header-actions button:hover {
            opacity: 0.9;
        }
        
        .history-entry-content {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .history-entry-meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .history-entry-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-entry-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .history-entry-input,
        .history-entry-content,
        .history-entry-prompt {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .history-entry h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }
        
        .input-content,
        .prompt-content {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
            color: #666;
        }

        .history-sections {
            margin: 15px 0;
        }

        .history-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            padding: 15px;
        }

        .history-section h4 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        .history-section h5 {
            color: #495057;
            margin: 10px 0 5px 0;
            font-size: 0.9em;
        }

        .section-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .section-actions button {
            padding: 4px 8px;
            font-size: 0.8em;
            background: #e9ecef;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .section-actions button:hover {
            background: #dee2e6;
        }

        .view-output-btn {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .view-output-btn:hover {
            background-color: #45a049;
        }
        
        .history-entry {
            transition: all 0.3s ease;
        }
        
        .history-sections {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .history-entry-content {
            padding: 20px;
            background: #fff;
            border-radius: 4px;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .history-sections {
            max-height: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .sort-select {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            margin-bottom: 20px;
        }

        .history-entry-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-entry-meta {
            font-size: 14px;
            color: #2c3e50;
        }

        .input-preview {
            color: #2c3e50;
            font-weight: 500;
        }

        .history-entry-content.collapsed {
            display: none;
        }

        .history-entry-content {
            padding: 20px;
            background: #fff;
            border-radius: 4px;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .history-sections {
            max-height: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .output-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
        }

        .history-entry-content {
            padding: 20px;
            background: #fff;
            border-radius: 4px;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            min-height: 400px;  /* Make content area taller */
        }

        .history-entry-input h4 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 5px;  /* Reduce space after header */
            margin-top: 0;      /* Remove top margin */
        }

        .input-content {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
            color: #333;
            padding: 5px 0;     /* Reduce padding */
            background: #fff;
            margin-top: 0;      /* Remove top margin */
            border: none;       /* Remove border */
        }

        .history-sections {
            max-height: none;
            padding: 15px 0;    /* Adjust padding */
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 300px;  /* Ensure minimum height for output */
        }

        .output-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
            padding: 0 15px;    /* Add some horizontal padding */
        }

        /* Adjust spacing for output header */
        .output-content h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        /* Make the content area wider */
        .history-container {
            max-width: 1400px;  /* Increase from 1200px */
        }

        .header-actions .delete-btn {
            background-color: #dc3545;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .header-actions .delete-btn:hover {
            background-color: #c82333;
        }

        .header-actions .delete-btn i {
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Update tab button styles */
        .tablinks {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            color: #2c3e50;
        }

        /* Update hover state */
        .tablinks:hover {
            background-color: #e8f5e9;  /* Light green background */
            color: #4CAF50;  /* Green text */
        }

        /* Update active state */
        .tablinks.active {
            background-color: #4CAF50;  /* Solid green background */
            color: white;  /* White text */
        }

        /* Add transition for smooth color changes */
        .tablinks {
            transition: all 0.3s ease;
        }

        /* Update tab navigation container */
        .tab {
            overflow: hidden;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Add active hover state */
        .tablinks.active:hover {
            background-color: #45a049;  /* Slightly darker green */
        }

        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .profile-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .password-reset-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .profile-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .profile-input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        .save-profile-btn, .reset-password-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .save-profile-btn:hover, .reset-password-btn:hover {
            background-color: #45a049;
        }

        .reset-password-btn {
            background-color: #2196F3;
        }

        .reset-password-btn:hover {
            background-color: #1976D2;
        }

        .profile-input[readonly] {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
            border: 1px solid #ddd;
        }

        .profile-input[readonly]:focus {
            box-shadow: none;
            border-color: #ddd;
        }

        /* Add these styles to your existing style section */
        .profile-info-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item label {
            font-weight: 500;
            color: #495057;
            width: auto;
        }

        .info-item span {
            color: #6c757d;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Update readonly input styles */
        .profile-input[readonly] {
            background-color: #f5f5f5 !important;
            color: #666 !important;
            cursor: not-allowed !important;
            border: 1px solid #ddd !important;
            user-select: none;
        }

        .profile-input[readonly]:focus {
            box-shadow: none !important;
            border-color: #ddd !important;
        }
    </style>
    <!-- Add Font Awesome in the head section if not already present -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <!-- Add this HTML right after your body tag starts -->
    <div class="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text">Generating your paper...</div>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab">
            <div class="nav-buttons">
                <button class="tablinks" onclick="openTab(event, 'Input')">New Paper</button>
                <button class="tablinks" onclick="openTab(event, 'History')">Generated Papers</button>
                <button class="tablinks" onclick="openTab(event, 'Output')">Backend Prompt</button>
                <button class="tablinks" onclick="openTab(event, 'API')">Settings</button>
                <button class="tablinks" onclick="openTab(event, 'Profile')">Profile</button>
            
            <div class="action-buttons">
                <button id="generateButton" class="generate-btn" style="background-color: #4CAF50; color: white;">Generate Paper</button>
                <button onclick="downloadAsPDF()" id="downloadBtn" class="generate-btn" style="background-color: #2196F3; color: white; display: none;">Download PDF</button>
                <button class="tablinks" onclick="logout()" style="background-color: #f44336; color: white;">Logout (<span id="headerEmail"></span>)</button>
            </div>
        </div>
        </div>

        <!-- Research Tab Content -->
        <div id="Input" class="tabcontent">
            <!-- Section selector panel with integrated inputs -->
            <div class="section-selector">
                <div class="section-selector-header">
                    <h3>Research Paper Sections</h3>
                </div>
                
                <div class="input-mode-selector">
                    <label>
                        <input type="radio" name="inputMode" value="combined" checked> Combined Input
                    </label>
                    <!-- <label>
                        <input type="radio" name="inputMode" value="individual"> Individual Inputs
                    </label> -->
                </div>
<!-- 
                <div class="web-scraping-control">
                    <label>
                        <input type="checkbox" id="enableWebScraping" onchange="handleWebScrapingToggle(this)"> Enable Web Scraping
                    </label>
                </div>
                 -->
                <!-- Combined input area -->
                <div id="combinedInputArea" class="combined-input">
                    <textarea id="collectiveInput" placeholder="Enter your research details here..."></textarea>
                </div>

                <!-- Sections with integrated individual inputs -->
                <div class="section-list">
                    <div class="selector-controls">
                        <button onclick="selectAllSections()">Select All</button>
                        <button onclick="deselectAllSections()">Deselect All</button>
                    </div>
                    <div class="section-checkboxes" id="sectionCheckboxes"></div>
                </div>

                <div class="generate-button-container">
                    <button id="generateButton2" class="generate-btn">Generate Paper</button>
                </div>
            </div>

            <!-- Paper output area -->
            <div class="paper-layout">
                <div class="paper-output">
                    <div id="combinedOutput" class="research-paper">
                        <div class="paper-header">
                            <h1>Research Paper</h1>
                        </div>
                        <div class="combined-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Tab Content -->
        <div id="Output" class="tabcontent">
            <div class="prompt-sections">
                <div class="section-nav">
                    <button onclick="showPromptConfig('objective')" class="active">1. Objective</button>
                    <button onclick="showPromptConfig('design')">2. Design</button>
                    <button onclick="showPromptConfig('introduction')">3. Introduction</button>
                    <button onclick="showPromptConfig('literature')">4. Literature</button>
                    <button onclick="showPromptConfig('methods')">5. Methods</button>
                    <button onclick="showPromptConfig('results')">6. Results</button>
                    <button onclick="showPromptConfig('analysis')">7. Analysis</button>
                    <button onclick="showPromptConfig('interpretation')">8. Interpretation</button>
                    <button onclick="showPromptConfig('discussion')">9. Discussion</button>
                    <button onclick="showPromptConfig('conclusion')">10. Conclusion</button>
                    <button onclick="showPromptConfig('references')">11. References</button>
                    <button onclick="showPromptConfig('submission')">12. Submission</button>
                </div>

                <!-- Prompt Configuration Sections -->
                <div id="objective-prompt" class="prompt-config active">
                    <h3>Research Objective Prompt Template</h3>
                    <div class="section-description">Customize how the AI should generate research objectives.</div>
                    <textarea class="prompt-area" id="objectivePrompt">Based on the following research topic:

{input}

Please generate:
1. Primary Research Objective
2. Secondary Objectives (2-3)
3. Specific Research Questions
4. Research Hypotheses
5. Scope and Limitations

Format the output with clear headings and bullet points.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('objective')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Study Design Prompt -->
                <div id="design-prompt" class="prompt-config">
                    <h3>Study Design Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating study design.</div>
                    <textarea class="prompt-area" id="designPrompt">Based on these research objectives:

{input}

Please provide a comprehensive study design including:
1. Research Approach (Qualitative/Quantitative/Mixed)
2. Study Type (e.g., Experimental, Observational, etc.)
3. Data Collection Methods
4. Sampling Strategy
5. Timeline Recommendations
6. Potential Methodological Challenges

Format with clear sections and bullet points.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('design')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Introduction Prompt -->
                <div id="introduction-prompt" class="prompt-config">
                    <h3>Introduction Section Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating the introduction.</div>
                    <textarea class="prompt-area" id="introductionPrompt">As a researcher, write the introduction for the research article in a professional and academic tone covering the following aspects for {input}:
•	Introduce the disease_entity by giving the background and how it is linked to the study_title.
•	Introduce the study_title. Showcase what is known through the relevant past research on this title.
•	Explain significance and relevance of our study_title by showcasing magnitude of the problem in terms of magnitude (population affected, and morbidity and mortality) and demonstrating gaps in current understanding on the topic.
•	Explain the rationale of the topic: Why does it need to be addressed right now if relevant data is available.
•	Explain how this research will benefit patients and doctors with respect to the disease_entity
•	Use pyramid principle for the overall structure of the introduction.
•	Add references from scientific literature wherever facts are stated.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('introduction')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Literature Review Prompt -->
                <div id="literature-prompt" class="prompt-config">
                    <h3>Literature Review Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating literature review.</div>
                    <textarea class="prompt-area" id="literaturePrompt">Based on this research topic:

{input}
As a researcher in medical science, write the review of literature in a professional and academic tone, covering 10-15 most relevant previous research studies on the study_title to showcase how the current understanding on the disease_entity has progressed and what are the lacuna or gaps in the existing knowledge. 
Add references from scientific literature wherever facts are stated.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('literature')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Methods Prompt -->
                <div id="methods-prompt" class="prompt-config">
                    <h3>Methods Section Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating methodology.</div>
                    <textarea class="prompt-area" id="methodsPrompt">Based on this research approach:

{input}

Please provide detailed methodology including:
1. Research Design
2. Population and Sampling
3. Data Collection Methods
4. Instruments and Materials
5. Procedures
6. Ethical Considerations
7. Data Analysis Methods
8. Validity and Reliability

Format with clear subsections and detailed procedures.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('methods')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Results Prompt -->
                <div id="results-prompt" class="prompt-config">
                    <h3>Results Section Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating results.</div>
                    <textarea class="prompt-area" id="resultsPrompt">Based on these findings:

{input}

Please organize and present the results including:
1. Overview of Data Collected
2. Primary Findings
3. Statistical Analyses
4. Key Patterns and Trends
5. Unexpected Findings
6. Tables and Figures Description
7. Summary of Results

Present results objectively without interpretation.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('results')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Analysis Prompt -->
                <div id="analysis-prompt" class="prompt-config">
                    <h3>Data Analysis Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating data analysis.</div>
                    <textarea class="prompt-area" id="analysisPrompt">Based on these results:

{input}

Please provide comprehensive data analysis including:
1. Statistical Methods Used
2. Data Processing Steps
3. Quantitative Analysis
4. Qualitative Analysis (if applicable)
5. Statistical Significance
6. Effect Sizes
7. Correlation Analysis
8. Regression Analysis (if applicable)

Format with clear analytical steps.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('analysis')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Interpretation Prompt -->
                <div id="interpretation-prompt" class="prompt-config">
                    <h3>Data Interpretation Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating interpretation.</div>
                    <textarea class="prompt-area" id="interpretationPrompt">Based on the analysis:

{input}

Please provide detailed interpretation including:
1. Meaning of Results
2. Patterns and Trends
3. Relationship to Research Questions
4. Comparison with Expected Outcomes
5. Theoretical Implications
6. Practical Implications
7. Limitations of Interpretation

Format with clear reasoning.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('interpretation')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Discussion Prompt -->
                <div id="discussion-prompt" class="prompt-config">
                    <h3>Discussion Section Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating discussion.</div>
                    <textarea class="prompt-area" id="discussionPrompt">Based on these findings:

{input}

Please provide a comprehensive discussion including:
1. Summary of Key Findings
2. Relationship to Existing Literature
3. Theoretical Implications
4. Practical Implications
5. Strengths and Limitations
6. Unexpected Findings
7. Future Research Directions
8. Recommendations

Format with clear arguments and scholarly tone.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('discussion')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Conclusion Prompt -->
                <div id="conclusion-prompt" class="prompt-config">
                    <h3>Conclusion Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating conclusion.</div>
                    <textarea class="prompt-area" id="conclusionPrompt">Based on the complete study:

{input}

Please provide a comprehensive conclusion including:
1. Summary of Research Purpose
2. Key Findings and Outcomes
3. Theoretical Contributions
4. Practical Implications
5. Limitations
6. Future Research Directions
7. Final Thoughts

Format concisely while capturing the essence of the study.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('conclusion')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- References Prompt -->
                <div id="references-prompt" class="prompt-config">
                    <h3>References Section Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating references.</div>
                    <textarea class="prompt-area" id="referencesPrompt">{input}
As a researcher in medical science, list top 15-20 relevant studies for past research on Study_title by reading through abstracts and listing the information:
Article title, author name (upto 2), article submission year (date), article acceptance year (date), study design/methodology, sample size, age group, study population, geography, study results, conclusion, open access status, journal name and article URL (doi). </textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('references')" class="save-btn">Save Template</button>
                    </div>
                </div>

                <!-- Submission Prompt -->
                <div id="submission-prompt" class="prompt-config">
                    <h3>Submission Guidelines Prompt Template</h3>
                    <div class="section-description">Customize the prompt for generating submission guidelines.</div>
                    <textarea class="prompt-area" id="submissionPrompt">Based on these requirements:

{input}

Please provide submission guidelines including:
1. Formatting Requirements
2. File Format Specifications
3. Document Structure
4. Word Count/Page Limits
5. Citation Style
6. Figure and Table Guidelines
7. Submission Checklist
8. Cover Letter Requirements

Format as a clear checklist for submission.</textarea>
                    <div class="prompt-actions">
                        <button onclick="savePromptTemplate('submission')" class="save-btn">Save Template</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Settings Tab Content -->
        <div id="API" class="tabcontent">
            <div class="api-settings-container">
                <h2>API Configuration</h2>
                
                <!-- Model Selection -->
                <div class="api-section">
                    <label for="modelSelection">Select AI Model:</label>
                    <select id="modelSelection" class="model-select" onchange="handleModelChange()">
                        <option value="gemini">Google Gemini</option>
                        <option value="chatgpt">ChatGPT</option>
                        <option value="deepseek">DeepSeek</option>
                    </select>
                </div>
                
                <!-- Gemini API Settings -->
                <div class="api-section" id="geminiSettings">
                    <h3>Gemini API Settings</h3>
                    <label for="geminiApiKey">API Key:</label>
                    <input type="password" 
                           id="geminiApiKey" 
                           class="api-key-input" 
                           placeholder="Enter Gemini API Key">
                    <label for="geminiModel">Model:</label>
                    <select id="geminiModel" class="model-select">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-pro-002">Gemini 1.5 Pro 002</option>
                        <option value="gemini-1.5-pro-001">Gemini 1.5 Pro 001</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-flash-lite-preview-02-05">Gemini 2.0 Flash Lite Preview</option>
                        <option value="gemini-2.0-pro">Gemini 2.0 Pro</option>
                        <option value="gemini-2.0-pro-001">Gemini 2.0 Pro 001</option>
                        <option value="gemini-2.0-pro-002">Gemini 2.0 Pro 002</option>
                    </select>
                    <div id="geminiApiStatus" class="api-status"></div>
                </div>
                
                <!-- ChatGPT API Settings -->
                <div class="api-section" id="chatgptSettings">
                    <h3>ChatGPT API Settings</h3>
                    <label for="chatgptApiKey">API Key:</label>
                    <input type="password" 
                           id="chatgptApiKey" 
                           class="api-key-input" 
                           placeholder="Enter OpenAI API Key">
                    <label for="chatgptModel">Model:</label>
                    <select id="chatgptModel" class="model-select">
                        <!-- O-Series Models -->
                        <optgroup label="O-Series Models">
                            <option value="gpt-4o">GPT-4O</option>
                            <option value="chatgpt-4o-latest">ChatGPT-4O Latest</option>
                            <option value="gpt-4o-mini">GPT-4O Mini</option>
                            <option value="o1">O1</option>
                            <option value="o1-mini">O1 Mini</option>
                            <option value="o3-mini">O3 Mini</option>
                        </optgroup>

                        <!-- Preview Models -->
                        <optgroup label="Preview Models">
                            <option value="o1-preview">O1 Preview</option>
                            <option value="gpt-4o-realtime-preview">GPT-4O Realtime Preview</option>
                            <option value="gpt-4o-mini-realtime-preview">GPT-4O Mini Realtime Preview</option>
                            <option value="gpt-4o-audio-preview">GPT-4O Audio Preview</option>
                        </optgroup>
                    </select>
                    <div id="chatgptApiStatus" class="api-status"></div>
                </div>
                
                <!-- DeepSeek API Settings -->
                <div id="deepseekSettings" class="model-settings" style="display: none;">
                    <label>DeepSeek API Key:</label>
                    <input type="password" id="deepseekApiKey" class="api-key-input">
                    <label>Model:</label>
                    <select id="deepseekModel" class="model-select">
                        <option value="deepseek-chat">DeepSeek Chat(V3)</option>
                        <option value="deepseek-reasoner">deepseek Reasoner(R1)</option>
                    </select>
                </div>
                
                <div class="api-buttons">
                    <!-- <button onclick="testApiKeys()" class="btn test-btn">Test API Keys</button> -->
                    <button onclick="saveApiKeys()" class="btn save-btn">Save API Keys</button>
                </div>
            </div>
        </div>

        <!-- Prompts Tab Content -->
        <div id="Prompts" class="tabcontent">
            <!-- Existing Prompts tab content -->
        </div>

        <!-- Add corresponding tab content div (even though it won't be used) -->
        <div id="Logout" class="tabcontent">
            <!-- This can remain empty as logout is handled by the button click -->
        </div>

        <!-- History Tab Content -->
        <div id="History" class="tabcontent">
            <div class="history-container">
                <h2>Generation History</h2>
                <div class="history-filters">
                    <div class="sort-container">
                        <select id="sortOrder" class="sort-select" onchange="loadHistory()">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>
                <div id="historyList" class="history-list">
                    <!-- History entries will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile Tab Content -->
        <div id="Profile" class="tabcontent">
            <div class="profile-container">
                <h2>User Profile</h2>
                <div class="profile-form">
                    <div class="form-group">
                        <label for="userName">Full Name:</label>
                        <input type="text" id="userName" class="profile-input" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="userCollege">College/Institution:</label>
                        <input type="text" id="userCollege" class="profile-input" placeholder="Enter your college/institution">
                    </div>
                    
                    <div class="form-group">
                        <label for="profileEmail">Email:</label>
                        <input type="email" 
                               id="profileEmail" 
                               class="profile-input" 
                               readonly 
                               style="background-color: #f5f5f5; color: #666; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group">
                        <label for="userPhone">Phone Number:</label>
                        <input type="tel" id="userPhone" class="profile-input" placeholder="Enter your phone number">
                    </div>
                    
                    <button onclick="saveProfile()" class="save-profile-btn">Save Profile</button>
                </div>

                <div class="password-reset-section">
                    <h3>Reset Password</h3>
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" class="profile-input" placeholder="Enter current password">
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" class="profile-input" placeholder="Enter new password">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" class="profile-input" placeholder="Confirm new password">
                    </div>
                    
                    <button onclick="resetPassword()" class="reset-password-btn">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";
            
            // Load appropriate data when switching tabs
            if (tabName === 'History') {
                loadHistory();
            } else if (tabName === 'Profile') {
                loadUserProfile();
            } else if (tabName === 'API') {
                updateVisibleSettings();
            }
        }

        // Initialize the first tab as active
        document.addEventListener('DOMContentLoaded', function() {
            // Open the Input tab by default
            document.querySelector('.tablinks').click();
            
            // Initialize model selection handler
            const modelSelect = document.getElementById('modelSelection');
            modelSelect.addEventListener('change', updateVisibleSettings);
            
            // Load saved settings
            loadSavedSettings();
            
            // Add click handler for both generate buttons
            const generateButtons = document.querySelectorAll('#generateButton, #generateButton2');
            generateButtons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Generate button clicked via event listener');
                    generateSelectedSections();
                });
            });
        });

        function updateVisibleSettings() {
            const selectedModel = document.getElementById('modelSelection').value;
            document.getElementById('geminiSettings').style.display = 
                selectedModel === 'gemini' ? 'block' : 'none';
            document.getElementById('chatgptSettings').style.display = 
                selectedModel === 'chatgpt' ? 'block' : 'none';
            document.getElementById('deepseekSettings').style.display = 
                selectedModel === 'deepseek' ? 'block' : 'none';
        }

        function loadSavedSettings() {
            const savedKeys = JSON.parse(localStorage.getItem('apiKeys')) || {};
            
            if (savedKeys.selectedModel) {
                document.getElementById('modelSelection').value = savedKeys.selectedModel;
            }
            if (savedKeys.geminiApiKey) {
                document.getElementById('geminiApiKey').value = savedKeys.geminiApiKey;
            }
            if (savedKeys.geminiModel) {
                document.getElementById('geminiModel').value = savedKeys.geminiModel;
            }
            if (savedKeys.chatgptApiKey) {
                document.getElementById('chatgptApiKey').value = savedKeys.chatgptApiKey;
            }
            if (savedKeys.chatgptModel) {
                document.getElementById('chatgptModel').value = savedKeys.chatgptModel;
            }
            if (savedKeys.deepseekApiKey) {
                document.getElementById('deepseekApiKey').value = savedKeys.deepseekApiKey;
            }
            if (savedKeys.deepseekModel) {
                document.getElementById('deepseekModel').value = savedKeys.deepseekModel;
            }
            
            updateVisibleSettings();
        }

        // API Key functions
        async function testApiKeys() {
            const selectedModel = document.getElementById('modelSelection').value;
            const geminiApiKey = document.getElementById('geminiApiKey').value;
            const geminiModel = document.getElementById('geminiModel').value;
            const chatgptApiKey = document.getElementById('chatgptApiKey').value;
            const chatgptModel = document.getElementById('chatgptModel').value;
            const deepseekApiKey = document.getElementById('deepseekApiKey').value;
            const deepseekModel = document.getElementById('deepseekModel').value;

            if (selectedModel === 'gemini' && (!geminiApiKey || !geminiModel)) {
                alert('Gemini API key and model selection are required!');
                return;
            }

            if (selectedModel === 'chatgpt' && (!chatgptApiKey || !chatgptModel)) {
                alert('ChatGPT API key and model selection are required!');
                return;
            }
            
            try {
                const response = await fetch('/test-api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selectedModel,
                        geminiApiKey,
                        geminiModel,
                        chatgptApiKey,
                        chatgptModel,
                        deepseekApiKey,
                        deepseekModel
                    })
                });
                
                const results = await response.json();
                
                document.getElementById('geminiApiStatus').innerHTML = 
                    results.geminiApi ? '✅ Valid' : '❌ Invalid';
                document.getElementById('chatgptApiStatus').innerHTML = 
                    results.chatgptApi ? '✅ Valid' : '❌ Invalid';
            } catch (error) {
                console.error('Error testing API keys:', error);
                alert('Error testing API keys. Check console for details.');
            }
        }

        function saveApiKeys() {
            const apiKeys = {
                selectedModel: document.getElementById('modelSelection').value,
                geminiApiKey: document.getElementById('geminiApiKey').value,
                geminiModel: document.getElementById('geminiModel').value,
                chatgptApiKey: document.getElementById('chatgptApiKey').value,
                chatgptModel: document.getElementById('chatgptModel').value,
                deepseekApiKey: document.getElementById('deepseekApiKey').value,
                deepseekModel: document.getElementById('deepseekModel').value
            };
            
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
            alert('API settings saved successfully!');
        }

        // Add authentication check
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = '/';
            } else {
                document.getElementById('userEmail').textContent = user.email;
            }
        });

        async function logout() {
            try {
                await fetch('/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Update your API calls to include the auth token
        async function getAuthToken() {
            const user = firebase.auth().currentUser;
            if (!user) {
                throw new Error('Not authenticated');
            }
            return await user.getIdToken();
        }

        // Modify your existing API calls to include the token
        async function generateSelectedSections() {
            console.log("Generate button clicked");
            const loadingOverlay = document.querySelector('.loading-overlay');
            const loadingText = document.querySelector('.loading-text');
            try {
                const selectedCheckboxes = document.querySelectorAll('.section-checkboxes input[type="checkbox"]:checked');
                console.log("Selected sections:", Array.from(selectedCheckboxes).map(cb => cb.value));
                
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one section to generate.');
                    return;
                }

                // Show loading overlay
                loadingOverlay.style.display = 'flex';

                const paperOutput = document.querySelector('.combined-content');
                const collectiveInput = document.getElementById('collectiveInput').value.trim();
                console.log("Collective input:", collectiveInput);
                
                const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
                let allResults = '';

                // Get selected model and API keys
                const selectedModel = document.getElementById('modelSelection').value;
                console.log("Selected model:", selectedModel);
                
                const requestPayload = {
                    model: selectedModel,
                    input: collectiveInput,
                    prompts: {} // Add this to store all prompts
                };

                // Process each selected section
                for (const checkbox of selectedCheckboxes) {
                    try {
                        const section = checkbox.value;
                        loadingText.textContent = `Generating ${section} section...`;

                        if (!collectiveInput) {
                            console.warn(`No input provided for section: ${section}`);
                            continue;
                        }

                        let enhancedInput = collectiveInput;
                        const promptTemplate = document.getElementById(`${section}Prompt`)?.value;
                        console.log(`Prompt template for ${section}:`, promptTemplate);

                        if (!promptTemplate) {
                            console.error(`No prompt template found for section: ${section}`);
                            continue;
                        }

                        const formattedPrompt = formatPromptWithInput(promptTemplate, enhancedInput);
                        console.log(`Formatted prompt for ${section}:`, formattedPrompt);

                        // Store the prompt in the payload
                        requestPayload.prompts[section] = formattedPrompt;

                        const sectionPayload = {
                            ...requestPayload,
                            input: enhancedInput,
                            prompt: formattedPrompt,
                            section: section
                        };

                        // Add API keys based on selected model
                        if (sectionPayload.model === 'gemini') {
                            sectionPayload.geminiApiKey = document.getElementById('geminiApiKey').value;
                            sectionPayload.geminiModel = document.getElementById('geminiModel').value;
                        } else if (sectionPayload.model === 'chatgpt') {
                            sectionPayload.chatgptKey = document.getElementById('chatgptApiKey').value;
                            sectionPayload.chatgptModel = document.getElementById('chatgptModel').value;
                        } else if (sectionPayload.model === 'deepseek') {
                            sectionPayload.deepseekApiKey = document.getElementById('deepseekApiKey').value;
                            sectionPayload.deepseekModel = document.getElementById('deepseekModel').value;
                        }

                        console.log("Sending request with payload:", { ...sectionPayload, apiKeys: "hidden" });

                        try {
                            const response = await fetch('/generate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    ...sectionPayload,
                                    allPrompts: requestPayload.prompts // Send all prompts with each request
                                }),
                                credentials: 'include'
                            });

                            console.log("Response status:", response.status);
                            if (!response.ok) {
                                if (response.status === 403) {
                                    window.location.href = '/';
                                    return;
                                }
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const data = await response.json();
                            console.log("Response data:", data);

                            if (data.content) {
                                const sectionInfo = sections.find(s => s.id === section);
                                allResults += `
                                    <div class="section-result">
                                        <h2>${sectionInfo ? sectionInfo.title : section}</h2>
                                        <div class="generated-content">
                                            ${formatGeminiOutput(data.content)}
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error(`Error generating content for ${section}:`, error);
                            if (error.message.includes('403')) {
                                window.location.href = '/';
                                return;
                            }
                            allResults += `
                                <div class="error-message">
                                    Error generating content for ${section}: ${error.message}
                                </div>
                            `;
                        }
                    } catch (sectionError) {
                        console.error(`Error processing section ${section}:`, sectionError);
                        allResults += `
                            <div class="error-message">
                                Error generating content for ${section}: ${sectionError.message}
                            </div>
                        `;
                    }
                }

                paperOutput.innerHTML = allResults || '<div class="error-message">No content was generated.</div>';

            } catch (error) {
                console.error('Generation error:', error);
                if (error.message.includes('403')) {
                    window.location.href = '/';
                    return;
                }
                const paperOutput = document.querySelector('.combined-content');
                paperOutput.innerHTML = `
                    <div class="error-message">
                        Error generating content: ${error.message}
                        <br>
                        <small>Check the console for more details.</small>
                    </div>
                `;
            } finally {
                console.log("Hiding loading overlay");
                loadingOverlay.style.display = 'none';
                loadingText.textContent = "Generating your paper...";  // Reset loading text
            }
        }

        // Add authentication check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/verify-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        });
    </script>

    <!-- Add this script section before your existing scripts -->
    <script>
        function formatMarkdown(text) {
            if (!text) return '';

            // Handle triple backticks for multi-line code blocks
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // Handle inline code wrapped in single backticks
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Replace headers (Markdown-style #, ##, ###)
            text = text.replace(/^### (.*)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*)$/gm, '<h1>$1</h1>');

            // Replace bold (**text** or __text__)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');

            // Replace italic (*text* or _text_)
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');

            // Only convert standalone numbers at start of lines to bullets
            // This will preserve intentional numbered lists from the prompt
            text = text.replace(/^(\d+\)|\d+\.)(?!\d)\s+(.*)$/gm, function(match, number, content) {
                // Check if this is part of a meaningful numbered sequence
                // If it's just a standalone number, convert to bullet
                if (!match.trim().match(/^[1-9][0-9]*[\.\)]\s/)) {
                    return '• ' + content;
                }
                return match; // Keep original numbering if it looks intentional
            });

            // Convert bullet points and asterisks to list items
            text = text.replace(/^[•*-]\s+(.*)$/gm, '<li>$1</li>');
            
            // Group consecutive list items into unordered lists
            text = text.replace(/(<li>.*?<\/li>(\s*<li>.*?<\/li>)*)/gs, '<ul>$1</ul>');

            // Handle paragraphs and line breaks
            text = text.replace(/\n\s*\n/g, '</p><p>');
            text = text.replace(/(?<!<\/li>|<\/code>)\n/g, '<br>');

            // Ensure content is wrapped in paragraph tags
            if (!text.startsWith('<')) {
                text = '<p>' + text + '</p>';
            }

            return text;
        }
        // Add styles for the formatted content
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            .generated-content {
                line-height: 1.6;
                font-family: Arial, sans-serif;
            }
            
            .generated-content h1 {
                font-size: 24px;
                color: #2c3e50;
                margin-top: 20px;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 2px solid #4CAF50;
            }
            
            .generated-content h2 {
                font-size: 20px;
                color: #34495e;
                margin-top: 15px;
                margin-bottom: 8px;
            }
            
            .generated-content h3 {
                font-size: 18px;
                color: #445566;
                margin-top: 12px;
                margin-bottom: 6px;
            }
            
            .generated-content ul, .generated-content ol {
                margin: 10px 0;
                padding-left: 20px;
            }
            
            .generated-content li {
                margin: 5px 0;
            }
            
            .generated-content p {
                margin: 10px 0;
            }
            
            .generated-content strong {
                font-weight: 600;
                color: #2c3e50;
            }
            
            .generated-content em {
                font-style: italic;
                color: #34495e;
            }
        `;
        document.head.appendChild(styleSheet);
    </script>

    <script>
        // Add this to ensure all prompts are loaded on startup
        document.addEventListener('DOMContentLoaded', function() {
            const sections = [
                'objective', 'design', 'introduction', 'literature', 
                'methods', 'results', 'analysis', 'interpretation', 
                'discussion', 'conclusion', 'references', 'submission'
            ];
            
            sections.forEach(section => {
                const savedTemplate = localStorage.getItem(`${section}Prompt`);
                const promptElement = document.getElementById(`${section}Prompt`);
                if (savedTemplate && promptElement) {
                    promptElement.value = savedTemplate;
                }
            });
        });
    </script>

    <!-- Add this script section at the end of your body tag -->
    <script>
        // Function to handle tab switching
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            }
        }

        // Function to show specific prompt configuration
        function showPromptConfig(section) {
            // Hide all prompt configs
            document.querySelectorAll('.prompt-config').forEach(config => {
                config.classList.remove('active');
            });
            
            // Show selected prompt config
            const selectedConfig = document.getElementById(`${section}-prompt`);
            if (selectedConfig) {
                selectedConfig.classList.add('active');
            }
            
            // Update nav buttons
            document.querySelectorAll('.section-nav button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.section-nav button[onclick*="${section}"]`).classList.add('active');
        }

        // Function to save prompt templates
        function savePromptTemplate(section) {
            const template = document.getElementById(`${section}Prompt`).value;
            localStorage.setItem(`${section}Prompt`, template);
            alert(`Prompt template for ${section} saved successfully!`);
        }

        // Update the getAPIKeys function
        function getAPIKeys() {
            try {
                const savedKeys = JSON.parse(localStorage.getItem('apiKeys')) || {};
                const selectedModel = document.getElementById('modelSelection').value;
                console.log('Selected model:', selectedModel);
                console.log('Saved keys:', { ...savedKeys, geminiApiKey: '***', chatgptApiKey: '***' });
                
                const baseKeys = {
                    model: selectedModel
                };
                
                if (selectedModel === 'gemini') {
                    const geminiApiKey = savedKeys.geminiApiKey || document.getElementById('geminiApiKey')?.value;
                    const geminiModel = savedKeys.geminiModel || document.getElementById('geminiModel').value;
                    if (!geminiApiKey || !geminiModel) {
                        throw new Error('Gemini API key and model are required');
                    }
                    return {
                        ...baseKeys,
                        geminiApiKey,
                        geminiModel
                    };
                } else if (selectedModel === 'chatgpt') {
                    const chatgptKey = savedKeys.chatgptApiKey || document.getElementById('chatgptApiKey').value;
                    const chatgptModel = savedKeys.chatgptModel || document.getElementById('chatgptModel').value;
                    if (!chatgptKey || !chatgptModel) {
                        throw new Error('ChatGPT API key and model are required');
                    }
                    return {
                        ...baseKeys,
                        chatgptKey,
                        chatgptModel
                    };
                } else if (selectedModel === 'deepseek') {
                    const deepseekApiKey = savedKeys.deepseekApiKey || document.getElementById('deepseekApiKey').value;
                    const deepseekModel = savedKeys.deepseekModel || document.getElementById('deepseekModel').value;
                    if (!deepseekApiKey || !deepseekModel) {
                        throw new Error('DeepSeek API key and model are required');
                    }
                    return {
                        ...baseKeys,
                        deepseekApiKey,
                        deepseekModel
                    };
                }
            } catch (error) {
                console.error('Error getting API keys:', error);
                throw new Error('Failed to retrieve API keys. Please check your API Settings.');
            }
        }

        // Helper function to debug the configuration screen structure
        function debugConfigStructure() {
            console.log('=== Configuration Screen Structure ===');
            // Log all textareas in the configuration tab
            document.querySelectorAll('textarea').forEach(textarea => {
                console.log('Found textarea:', {
                    id: textarea.id,
                    name: textarea.name,
                    dataSection: textarea.dataset.section,
                    value: textarea.value.trim().substring(0, 50) + '...',
                    parent: textarea.parentElement.id
                });
            });
        }

        // Updated getLatestPrompt function to match your configuration screen structure
        function getLatestPrompt(section) {
            // Log the section we're looking for
            console.log(`Searching for prompt for section: ${section}`);

            // List all possible selectors for the prompt textarea
            const selectors = [
                `#prompt-${section}`,              // Try standard ID format
                `#${section}-prompt`,              // Try alternate ID format
                `textarea[name="prompt-${section}"]`, // Try name attribute
                `textarea[data-section="${section}"]`, // Try data attribute
                `#section-${section} textarea`,     // Try parent section
                `textarea[id*="${section}"]`,       // Try partial ID match
                'textarea'                          // Get all textareas as fallback
            ];

            // Log all textareas in the document for debugging
            const allTextareas = document.querySelectorAll('textarea');
            console.log('All textareas found:', Array.from(allTextareas).map(t => ({
                id: t.id,
                name: t.name,
                value: t.value ? 'Has content' : 'Empty',
                dataset: t.dataset
            })));

            // Try each selector
            for (const selector of selectors) {
                const elements = document.querySelectorAll(selector);
                console.log(`Trying selector "${selector}":`, elements.length, 'elements found');
                
                // Check each matching element
                for (const element of elements) {
                    if (element.value && element.value.trim()) {
                        // If this textarea contains the section name in its ID or data attributes
                        const isRelevant = 
                            element.id.includes(section) || 
                            element.name.includes(section) || 
                            element.dataset.section === section;

                        if (isRelevant) {
                            console.log(`Found matching prompt for ${section}:`, {
                                element: element,
                                value: element.value.trim().substring(0, 50) + '...'
                            });
                            return element.value.trim();
                        }
                    }
                }
            }

            // If we get here, we couldn't find the prompt
            console.error(`No prompt found for section "${section}" after trying all selectors`);
            return null;
        }

        // Add this function to handle prompt formatting with user input
        function formatPromptWithInput(promptTemplate, userInput) {
            // Replace all instances of {input} with the actual user input
            return promptTemplate.replace(/{input}/g, userInput);
        }

        // Simplify handleWebScrapingToggle to just validate input
        function handleWebScrapingToggle(checkbox) {
            if (checkbox.checked) {
                const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
                let userInput;
                
                if (inputMode === 'combined') {
                    userInput = document.getElementById('collectiveInput')?.value?.trim();
                } else {
                    userInput = document.getElementById('literature-input')?.value?.trim();
                }

                if (!userInput) {
                    alert('Please enter research input before enabling web search.');
                    checkbox.checked = false;
                    return;
                }
            }
        }
    </script>

    <!-- Add these styles for better visibility of active states -->
    <style>
        .prompt-config {
            display: none;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .prompt-config.active {
            display: block;
        }

        .section-nav button {
            width: 100%;
            text-align: left;
            padding: 10px;
            margin: 5px 0;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .section-nav button.active {
            background: #4CAF50;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #d63031;
            padding: 10px;
            background: #ffe3e3;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #2ecc71;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>

    <script>
        // Define sections with their default selection state
        const sections = [
            // { id: 'objective', title: 'Research Objective', defaultSelected: false },
            // { id: 'design', title: 'Study Design', defaultSelected: false },
            { id: 'introduction', title: 'Introduction', defaultSelected: true },
            { id: 'literature', title: 'Literature Review', defaultSelected: true },
            // { id: 'methods', title: 'Methods', defaultSelected: false },
            // { id: 'results', title: 'Results', defaultSelected: false },
            // { id: 'analysis', title: 'Analysis', defaultSelected: false },
            // { id: 'interpretation', title: 'Interpretation', defaultSelected: false },
            // { id: 'discussion', title: 'Discussion', defaultSelected: false },
            // { id: 'conclusion', title: 'Conclusion', defaultSelected: false },
            { id: 'references', title: 'References', defaultSelected: true },
            // { id: 'submission', title: 'Submission Guidelines', defaultSelected: false }
        ];

        // Function to populate section checkboxes
        function populateSectionCheckboxes() {
            const container = document.getElementById('sectionCheckboxes');
            container.innerHTML = ''; // Clear existing checkboxes

            sections.forEach(section => {
                const sectionItem = document.createElement('div');
                sectionItem.className = 'section-item';
                
                const label = document.createElement('label');
                label.className = 'section-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = section.id;
                checkbox.checked = section.defaultSelected; // Set default state
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(section.title));
                
                sectionItem.appendChild(label);
                
                // Add individual input area if needed
                const inputArea = document.createElement('div');
                inputArea.className = 'individual-input';
                inputArea.style.display = 'none'; // Hidden by default for combined mode
                inputArea.innerHTML = `
                    <textarea id="${section.id}-input" 
                              placeholder="Enter specific input for ${section.title}..."></textarea>
                `;
                
                sectionItem.appendChild(inputArea);
                container.appendChild(sectionItem);
            });
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            populateSectionCheckboxes();
            // ... rest of your DOMContentLoaded handlers ...
        });
    </script>

    <script>
        // Only updating these specific functions, everything else remains unchanged
        function selectAllSections() {
            document.querySelectorAll('.section-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
                // Update individual input visibility if in individual mode
                const inputArea = checkbox.closest('.section-item').querySelector('.individual-input');
                if (inputArea && document.querySelector('input[name="inputMode"]:checked').value === 'individual') {
                    inputArea.style.display = 'block';
                }
            });
        }

        function deselectAllSections() {
            document.querySelectorAll('.section-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                // Update individual input visibility if in individual mode
                const inputArea = checkbox.closest('.section-item').querySelector('.individual-input');
                if (inputArea) {
                    inputArea.style.display = 'none';
                }
            });
        }
    </script>

    <script>
        // Add the formatGeminiOutput function
        function formatGeminiOutput(content) {
            if (!content) return '';
            
            return content
                // Headers
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Lists
                .replace(/^\s*[-*+]\s+(.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                // Numbered lists
                .replace(/^\d+\.\s+(.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ol>$1</ol>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Paragraphs
                .replace(/\n\n/g, '</p><p>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Wrap in paragraph if not already wrapped
                .replace(/^(.+)$/, '<p>$1</p>');
        }
    </script>

    <!-- Add this script section before the closing body tag -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        function downloadAsPDF() {
            // Get the input content
            const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
            let userInput = inputMode === 'combined' 
                ? document.getElementById('collectiveInput').value
                : Array.from(document.querySelectorAll('.individual-input textarea'))
                      .filter(textarea => textarea.value.trim())
                      .map(textarea => `${textarea.id.replace('-input', '')}: ${textarea.value}`)
                      .join('\n\n');

            // Create a temporary div for the PDF content
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1 style="color: #2c3e50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">Research Paper</h1>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                        <h2 style="color: #34495e; margin-top: 0;">Research Input</h2>
                        <div style="white-space: pre-wrap; font-family: monospace;">${userInput}</div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h2 style="color: #34495e;">Generated Content</h2>
                        ${document.querySelector('.combined-content').innerHTML}
                    </div>
                </div>
            `;

            // Configure PDF options
            const opt = {
                margin: [10, 10],
                filename: 'research-paper.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate PDF
            html2pdf().from(pdfContent).set(opt).save();
        }

        // Modify generateSelectedSections to show/hide download button
        const originalGenerateSelectedSections = generateSelectedSections;
        generateSelectedSections = async function() {
            document.getElementById('downloadBtn').style.display = 'none';
            await originalGenerateSelectedSections();
            
            // Show download button if content was generated
            const content = document.querySelector('.combined-content');
            if (content && content.innerHTML && !content.innerHTML.includes('error-message')) {
                document.getElementById('downloadBtn').style.display = 'inline-block';
            }
        };
    </script>

    <script>
        async function loadHistory() {
            try {
                const response = await fetch('/history', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }
                
                const data = await response.json();
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                const sortOrder = document.getElementById('sortOrder').value;
                
                // Sort entries based on selected order
                const sortedEntries = data.history.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                });
                
                sortedEntries.forEach(entry => {
                    const entryElement = document.createElement('div');
                    entryElement.className = 'history-entry';
                    
                    // Get the first 100 characters of input text for preview
                    const inputPreview = entry.input_text.length > 100 ? 
                        entry.input_text.substring(0, 100) + '...' : 
                        entry.input_text;
                    
                    entryElement.innerHTML = `
                        <div class="history-entry-header" onclick="toggleHistoryEntry(this)">
                            <div class="header-content">
                                <div class="history-entry-meta">
                                    <span class="input-preview">${inputPreview}</span> • 
                                    ${new Date(entry.timestamp).toLocaleString()}
                                </div>
                                <div class="header-actions" onclick="event.stopPropagation()">
                                    <button class="delete-btn" onclick="deleteHistoryEntry(this, '${entry.timestamp}', '${entry.input_text.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="download-btn" onclick="downloadHistoryEntryAsPDF(this)">
                                        <i class="fas fa-download"></i> PDF
                                    </button>
                                    <button class="copy-btn" onclick="copyHistoryEntry(this)">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="history-entry-content collapsed">
                            <div class="history-entry-input">
                                <h4>Input:</h4>
                                <div class="input-content">
                                    ${entry.input_text.trim()}
                                </div>
                            </div>
                            <div class="history-sections">
                                <div class="output-content">
                                    <h4>Output:</h4>
                                    ${formatGeminiOutput(entry.output_text)}
                                </div>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(entryElement);
                });
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML = `
                    <div class="error-message">
                        Error loading history: ${error.message}
                    </div>
                `;
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert('Content copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }
        
        async function regenerateContent(input) {
            // Set the input and section in the main interface
            document.getElementById('collectiveInput').value = input;
            
            // Select all sections by default
            document.querySelectorAll('.section-checkboxes input[type="checkbox"]')
                .forEach(checkbox => checkbox.checked = true);
            
            // Switch to the Input tab
            openTab(null, 'Input');
            
            // Generate the content
            await generateSelectedSections();
        }
        
        // Add event listeners for filters
        document.getElementById('sortOrder').addEventListener('change', loadHistory);
        
        // Load history when the History tab is opened
        document.querySelector('button[onclick="openTab(event, \'History\')"]')
            .addEventListener('click', function() {
                console.log("History tab opened");
                loadHistory();
            });
    </script>

    <script>
        function usePromptTemplate(template, section) {
            // Find the prompt textarea for the section
            const promptTextarea = document.getElementById(`${section}Prompt`);
            if (promptTextarea) {
                promptTextarea.value = template;
                // Save the prompt template
                savePromptTemplate(section);
                // Switch to the Output tab
                openTab(null, 'Output');
            }
        }
    </script>

    <script>
        // Add these new functions
        function toggleOutput(button) {
            const historyEntry = button.closest('.history-entry');
            const sectionsDiv = historyEntry.querySelector('.history-sections');
            const isHidden = sectionsDiv.style.display === 'none';
            
            sectionsDiv.style.display = isHidden ? 'block' : 'none';
            button.textContent = isHidden ? 'Hide Output' : 'View Output';
        }
        
        function copyAllOutputs(button) {
            const historyEntry = button.closest('.history-entry');
            const sections = historyEntry.querySelectorAll('.history-section');
            let combinedText = '';
            
            sections.forEach(section => {
                const sectionTitle = section.querySelector('h4').textContent;
                const sectionContent = section.querySelector('.history-entry-content').textContent;
                combinedText += `${sectionTitle}\n${sectionContent}\n\n`;
            });
            
            navigator.clipboard.writeText(combinedText)
                .then(() => alert('All outputs copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }
    </script>

    <script>
        // Update the toggle function
        function toggleHistoryEntry(header) {
            const entry = header.closest('.history-entry');
            const content = entry.querySelector('.history-entry-content');
            const expandIcon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.display = 'block';
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('collapsed');
                content.style.display = 'none';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    </script>

    <script>
        // Update the downloadEntryAsPDF function
        function downloadEntryAsPDF(content, input) {
            try {
                // Create a styled container for PDF content
                const element = document.createElement('div');
                element.style.padding = '20px';
                element.style.fontFamily = 'Arial, sans-serif';
                element.style.maxWidth = '800px';
                element.style.margin = '0 auto';

                // Unescape any escaped quotes
                const cleanContent = content.replace(/\\'/g, "'");
                const cleanInput = input.replace(/\\'/g, "'");

                element.innerHTML = `
                    <style>
                        h1 { font-size: 24px; margin-bottom: 20px; color: #2c3e50; }
                        h2 { font-size: 20px; margin-top: 20px; color: #34495e; }
                        .input-section { 
                            background: #f8f9fa; 
                            padding: 15px; 
                            border-radius: 8px; 
                            margin: 15px 0; 
                        }
                        .output-section {
                            margin-top: 20px;
                            line-height: 1.6;
                        }
                    </style>
                    <h1>Research Paper</h1>
                    <div class="input-section">
                        <h2>Research Input:</h2>
                        <p>${cleanInput.trim()}</p>
                    </div>
                    <div class="output-section">
                        <h2>Generated Content:</h2>
                        ${formatGeminiOutput(cleanContent)}
                    </div>
                `;

                // Configure PDF options
                html2pdf()
                    .set({
                        margin: [20, 20],
                        filename: 'research_paper.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: true
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    })
                    .from(element)
                    .save()
                    .catch(err => {
                        console.error('PDF generation failed:', err);
                        alert('Failed to generate PDF. Please try again.');
                    });
            } catch (error) {
                console.error('Error in downloadEntryAsPDF:', error);
                alert('Failed to generate PDF. Please check the console for details.');
            }
        }

        // Add helper function to safely escape content for PDF
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>

    <script>
        // Function to copy history entry content
        function copyHistoryEntry(button) {
            const historyEntry = button.closest('.history-entry');
            const input = historyEntry.querySelector('.input-content').innerText;
            const output = historyEntry.querySelector('.output-content').innerText;
            
            const textToCopy = `Input:\n${input}\n\nOutput:\n${output}`;
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    // Show temporary success message
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy content. Please try again.');
                });
        }

        // Function to download history entry as PDF
        function downloadHistoryEntryAsPDF(button) {
            const historyEntry = button.closest('.history-entry');
            const input = historyEntry.querySelector('.input-content').innerText;
            const output = historyEntry.querySelector('.output-content').innerHTML;
            
            const element = document.createElement('div');
            element.style.padding = '20px';
            element.style.fontFamily = 'Arial, sans-serif';
            element.style.maxWidth = '800px';
            element.style.margin = '0 auto';

            element.innerHTML = `
                <style>
                    h1 { font-size: 24px; margin-bottom: 20px; color: #2c3e50; }
                    h2 { font-size: 20px; margin-top: 20px; color: #34495e; }
                    .input-section { 
                        background: #f8f9fa; 
                        padding: 15px; 
                        border-radius: 8px; 
                        margin: 15px 0; 
                    }
                    .output-section {
                        margin-top: 20px;
                        line-height: 1.6;
                    }
                    p { margin: 10px 0; }
                </style>
                <h1>Research Paper</h1>
                <div class="input-section">
                    <h2>Research Input:</h2>
                    <p>${input.trim()}</p>
                </div>
                <div class="output-section">
                    <h2>Generated Content:</h2>
                    ${output}
                </div>
            `;

            html2pdf()
                .set({
                    margin: [20, 20],
                    filename: 'research_paper.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true
                    }
                })
                .from(element)
                .save()
                .catch(err => {
                    console.error('PDF generation failed:', err);
                    alert('Failed to generate PDF. Please try again.');
                });
        }
    </script>

    <script>
        // Function to delete history entry
        async function deleteHistoryEntry(button, timestamp, input_text) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }
            
            try {
                const response = await fetch('/delete_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        timestamp: timestamp,
                        input_text: input_text
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to delete entry');
                }

                // Remove the entry from the UI
                const historyEntry = button.closest('.history-entry');
                historyEntry.style.opacity = '0';
                setTimeout(() => {
                    historyEntry.remove();
                }, 300);
            } catch (error) {
                console.error('Error deleting history entry:', error);
                alert('Failed to delete entry. Please try again.');
            }
        }
    </script>

    <script>
        // Function to load user profile
        async function loadUserProfile() {
            try {
                const user = window.auth.currentUser;
                if (!user) {
                    console.log('No user logged in');
                    return;
                }

                console.log('Loading profile for user:', user.email);
                
                // Set email in both profile and header
                const profileEmail = document.getElementById('profileEmail');
                const headerEmailSpan = document.getElementById('headerEmail');
                
                // Set email values
                if (profileEmail) {
                    profileEmail.value = user.email;
                    profileEmail.style.backgroundColor = '#f5f5f5';
                    profileEmail.style.color = '#666';
                    profileEmail.style.cursor = 'not-allowed';
                }
                
                if (headerEmailSpan) {
                    headerEmailSpan.textContent = user.email;
                }

                try {
                    const dbRef = window.dbRef(window.database);
                    const userRef = window.dbChild(dbRef, `users/${user.uid}`);
                    console.log('Attempting to fetch data for path:', `users/${user.uid}`);
                    
                    const snapshot = await window.dbGet(userRef);
                    console.log('Snapshot received:', snapshot);

                    if (snapshot.exists()) {
                        const profileData = snapshot.val();
                        console.log('Retrieved profile data:', profileData);

                        // Display all available fields
                        Object.keys(profileData).forEach(key => {
                            const input = document.getElementById(`user${key.charAt(0).toUpperCase() + key.slice(1)}`);
                            if (input && key !== 'uid' && key !== 'createdAt' && key !== 'updatedAt') {
                                input.value = profileData[key] || '';
                            }
                        });

                        // Show additional info in a read-only section
                        const profileForm = document.querySelector('.profile-form');
                        const infoSection = document.createElement('div');
                        infoSection.className = 'profile-info-section';
                        infoSection.innerHTML = `
                            <div class="info-item">
                                <label>Account Created:</label>
                                <span>${new Date(profileData.createdAt).toLocaleString()}</span>
                            </div>
                            ${profileData.updatedAt ? `
                                <div class="info-item">
                                    <label>Last Updated:</label>
                                    <span>${new Date(profileData.updatedAt).toLocaleString()}</span>
                                </div>
                            ` : ''}
                            <div class="info-item">
                                <label>User ID:</label>
                                <span>${profileData.uid}</span>
                            </div>
                        `;
                        
                        // Remove existing info section if it exists
                        const existingInfo = profileForm.querySelector('.profile-info-section');
                        if (existingInfo) {
                            existingInfo.remove();
                        }
                        
                        // Add the new info section before the save button
                        const saveButton = profileForm.querySelector('.save-profile-btn');
                        profileForm.insertBefore(infoSection, saveButton);

                    } else {
                        console.log('Creating new profile for user');
                        const initialProfile = {
                            name: '',
                            college: '',
                            phone: '',
                            email: user.email,
                            uid: user.uid,
                            createdAt: new Date().toISOString()
                        };
                        await window.dbSet(userRef, initialProfile);
                        console.log('Initial profile created');
                    }
                } catch (dbError) {
                    console.error('Database error details:', dbError);
                    throw new Error(`Database error: ${dbError.message}`);
                }
            } catch (error) {
                console.error('Profile loading error:', error);
                throw error;
            }
        }

        // Function to save user profile
        async function saveProfile() {
            try {
                const user = window.auth.currentUser;
                if (!user) {
                    throw new Error('No user logged in');
                }

                console.log('Current user UID:', user.uid);
                console.log('Current user email:', user.email);

                const profileData = {
                    name: document.getElementById('userName').value.trim(),
                    college: document.getElementById('userCollege').value.trim(),
                    phone: document.getElementById('userPhone').value.trim(),
                    email: user.email,
                    updatedAt: new Date().toISOString(),
                    uid: user.uid  // Add this line
                };

                console.log('Profile data to save:', profileData);

                if (!profileData.name) {
                    throw new Error('Please enter your name');
                }

                const saveButton = document.querySelector('.save-profile-btn');
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;

                try {
                    // Verify authentication state
                    const token = await user.getIdToken();
                    console.log('User is authenticated:', !!token);

                    // Create a direct reference to the user's profile
                    const userRef = window.dbRef(window.database, 'users/' + user.uid);
                    console.log('Database path:', 'users/' + user.uid);

                    // Attempt to save
                    await window.dbSet(userRef, profileData);
                    console.log('Profile saved successfully');
                    alert('Profile updated successfully!');
                } catch (dbError) {
                    console.error('Database error:', {
                        code: dbError.code,
                        message: dbError.message,
                        stack: dbError.stack,
                        path: 'users/' + user.uid
                    });
                    throw new Error(`Database error: ${dbError.message}`);
                } finally {
                    saveButton.textContent = 'Save Profile';
                    saveButton.disabled = false;
                }
            } catch (error) {
                console.error('Save profile error:', error);
                alert('Failed to save profile: ' + error.message);
            }
        }

        // Function to reset password
        async function resetPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            try {
                const user = window.auth.currentUser;
                if (!user) {
                    throw new Error('No user logged in');
                }

                // Show loading state
                const resetButton = document.querySelector('.reset-password-btn');
                resetButton.textContent = 'Resetting...';
                resetButton.disabled = true;

                try {
                    // Create credential with the correct provider
                    const credential = window.EmailAuthProvider.credential(
                        user.email,
                        currentPassword
                    );

                    try {
                        // First try to reauthenticate using the correct method
                        await window.reauthenticateWithCredential(user, credential);
                        console.log('Reauthentication successful');

                        // Then update password using the correct method
                        await window.updatePassword(user, newPassword);
                        console.log('Password update successful');
                        
                        // Clear password fields
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                        
                        alert('Password updated successfully!');
                    } catch (authError) {
                        console.error('Authentication error:', authError);
                        if (authError.code === 'auth/invalid-credential') {
                            throw new Error('Current password is incorrect');
                        } else if (authError.code === 'auth/weak-password') {
                            throw new Error('New password is too weak. It should be at least 6 characters');
                        } else if (authError.code === 'auth/requires-recent-login') {
                            throw new Error('Please log out and log back in before changing your password');
                        } else {
                            throw authError;
                        }
                    }
                } finally {
                    resetButton.textContent = 'Reset Password';
                    resetButton.disabled = false;
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Failed to reset password: ' + error.message);
            }
        }

        // Load profile when opening the Profile tab
        document.addEventListener('DOMContentLoaded', function() {
            const profileTab = document.querySelector('button[onclick="openTab(event, \'Profile\')"]');
            if (profileTab) {
                profileTab.addEventListener('click', loadUserProfile);
            }
        });
    </script>
</body>
</html> 
